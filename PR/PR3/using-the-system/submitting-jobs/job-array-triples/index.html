<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://supercloud.mit.edu/using-the-system/submitting-jobs/job-array-triples/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Job Array Triples - SuperCloud Docs</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Job Array Triples";
        var mkdocs_page_input_path = "using-the-system/submitting-jobs/job-array-triples.md";
        var mkdocs_page_url = "/using-the-system/submitting-jobs/job-array-triples/";
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> SuperCloud Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../requesting-account/">Requesting an Account</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../getting-started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../systems-and-software/">Systems and Software</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../acknowledging-us/">Acknowledging Us</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Using the System</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="#">Files and Data</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../files-and-data/transferring-files/">Transferring Files</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../files-and-data/shared-groups/">Shared Groups</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../software-packages/">Software and Package Management</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../monitoring-system-and-jobs/">Monintoring System and Job Status</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Submitting Jobs</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../submitting-jobs/">Submitting Jobs</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Job Array Triples</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#step-1-batch-up-your-array">Step 1: Batch Up your Array</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-2-changing-your-submission-script">Step 2: Changing Your Submission Script</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-3-submit-your-job-with-llsub-triples">Step 3: Submit your Job with LLsub Triples</a>
    </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Best Practices</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../best-practices/filesystem/">Best Practices for using the Filesystem</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../best-practices/gpu-jobs/">Optimizing your GPU Jobs</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../web-portal/">Web Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../databases/">Databases</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../jupyter-notebooks/">Jupyter Notebooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional Resources</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../faqs/">Frequently Asked Questions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../getting-help/">Getting Help</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Glossary</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">SuperCloud Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Using the System &raquo;</li>
          <li>Submitting Jobs &raquo;</li>
      <li>Job Array Triples</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="job-arrays-with-llsub-triples-in-3-steps-job_array_triples">Job Arrays with LLsub Triples in 3 Steps {#job_array_triples}<a class="headerlink" href="#job-arrays-with-llsub-triples-in-3-steps-job_array_triples" title="Permanent link"></a></h1>
<p>If you are currently running a Job Array, you can take advantage of
SuperCloud\'s triples mode submission by submitting your job array with
LLsub. In most cases, this can be done in a few easy steps.</p>
<p>What is triples mode? It\'s a different way to submit your job by
specifying three numbers:</p>
<ul>
<li>Nodes: The number of nodes you want to use up</li>
<li>NPPN: The number of processes that should run per node</li>
<li>NT: The number of threads per process</li>
</ul>
<p>Why would you want to use triples mode to submit your job? Triples mode
provides a few advantages. Since it does whole-node scheduling you
don\'t have to worry about other jobs impacting yours (or your job
impacting someone else\'s). We also do task-pinning when you request
resources with a triple, so your processes are arranged in the best way
possible for the layout of the hardware architecture. Finally,
submitting a Job Array with LLsub triples mode the way we describe here
will greatly reduce the startup time for your jobs, over a job array
with many pending tasks.</p>
<h2 id="step-1-batch-up-your-array">Step 1: Batch Up your Array<a class="headerlink" href="#step-1-batch-up-your-array" title="Permanent link"></a></h2>
<p>The first thing you want to do is set up your job so that your script
splits up your inputs among each process/task and each process/task
iterates a subset of your inputs. This way you can change your input set
without changing the number of tasks or processes that you schedule.
This step alone will save you on startup time. Anytime you submit more
jobs than your allocation allows, those additional jobs will remaining
pending until some of your first running jobs complete. Then, when one
of your first jobs complete, the scheduler now has to find the pending
job some resources and start it running. If you batch up your job array,
you only have to go through the scheduling process once. If you\'ve set
up a job array following our instructions in the past you may already be
doing this, and you can skip to the next section.</p>
<p>First you want to take a look at your code. Code that can be submitted
as a Job Array usually has one big for loop. If you are iterating over
multiple parameters or files, and have nested for loops, you\'ll first
want to enumerate all the combinations of what you are iterating over so
you have one big loop.</p>
<p>If your code is written so it uses the <code>$SLURM_ARRAY_TASK_ID</code> and uses
that to run a single thing, first add a for loop that iterates over the
full set of things you want to run your code on. If you can\'t rewrite
your code in such a way that it iterates over multiple inputs, you can
use LLMapReduce to submit your job with triples mode, see <a href="https://github.com/llsc-supercloud/teaching-examples/tree/master/C-Cpp/Fibonacci/LLMapReduce">this
example</a>.</p>
<p>Then you add a few lines to your code to take in two arguments, a
process/task ID and the number of processes/tasks, and use those numbers
to split up the thing you are iterating over. For example, I might have
a list of filenames, <code>fnames</code>. In python I would add:</p>
<blockquote>
<p><code># Grab the arguments that are passed in my_task_id = int(sys.argv[1]) num_tasks = int(sys.argv[2])</code></p>
<p><code># Assign indices to this process/task my_fnames = fnames[my_task_id:len(fnames):num_tasks]</code></p>
<p><code>for f in my_fnames: ...</code></p>
</blockquote>
<p>Notice that I am iterating over <code>my_fnames</code>, which is a subset of the
full list of filenames determined by the task ID and number of tasks.
This subset will be different for each task in the array. Note that the
third line of code will be different for languages with arrays that
start at index 1 (see the <a href="https://github.com/llsc-supercloud/teaching-examples/tree/master/Julia/word_count/JobArray">Julia Job
Array</a>
code for an example of this).</p>
<h2 id="step-2-changing-your-submission-script">Step 2: Changing Your Submission Script<a class="headerlink" href="#step-2-changing-your-submission-script" title="Permanent link"></a></h2>
<p>If you have been running your Job Arrays with sbatch, you most likely
have a few environment variables in your submission script. To submit
with LLsub triples, you can just replace these:</p>
<ul>
<li><code>$SLURM_ARRAY_TASK_ID</code> -> <code>$LLSUB_RANK</code></li>
<li><code>$SLURM_ARRAY_TASK_COUNT</code> -> <code>$LLSUB_SIZE</code></li>
</ul>
<p><strong>If you have any SBATCH flags in your submission script, remove those
as well</strong> (LLsub will see these and submit with sbatch, ignoring any
command line arguments you give it). For example, if you are running a
python script, your final submission script will look something like
this:</p>
<blockquote>
<p><code>#!/bin/bash</code></p>
<p><code># Initialize and Load Modules source /etc/profile module load anaconda/2020a</code></p>
<p><code>echo "My task ID: " $LLSUB_RANK echo "Number of Tasks: " $LLSUB_SIZE</code></p>
<p><code>python top5each.py $LLSUB_RANK $LLSUB_SIZE</code></p>
</blockquote>
<p>You will also need to make your script executable. You can do that with
this simple command line command:</p>
<blockquote>
<p><code>chmod u+x submit_LLsub.sh</code></p>
</blockquote>
<h2 id="step-3-submit-your-job-with-llsub-triples">Step 3: Submit your Job with LLsub Triples<a class="headerlink" href="#step-3-submit-your-job-with-llsub-triples" title="Permanent link"></a></h2>
<p>Now when you submit your job, you can run:</p>
<blockquote>
<p><code>LLsub ./submit.sh [NODES,NPPN,NT]</code></p>
</blockquote>
<p>where</p>
<ul>
<li><code>NODES</code> is the number of nodes you want to use up</li>
<li><code>NPPN</code> is the number of processes that should run per node</li>
<li><code>NT</code> is the number of threads per process</li>
</ul>
<p>The total number of threads per node, or <code>NT*NPPN</code>, should not be more
than the number of cores on the node, otherwise you may overwhelm the
node with too many running processes and/or threads. For example, if you
are running on the 48-core Xeon-P8 nodes, if you are running with
<code>NT</code>=1, you should not set <code>NPPN</code> more than 48. If <code>NT</code>=2, <code>NPPN</code> should
be at most 24, etc. The numbers you choose depend on your application,
if it is multithreaded it may be worth increasing <code>NT</code> and decreasing
<code>NPPN</code>. If your application consumes a lot of memory, you may need to
decrease <code>NPPN</code> so each process has the memory it needs to proceed. The
best way to determine what numbers to choose is to
<code>tune your triples &lt;#tuning&gt;</code>{.interpreted-text role="ref"}, which is a
relatively quick exercise and can improve your speedup in the long run
by helping you select the ideal numbers for your triple.</p>
<p>So if you want to run on 2 nodes, 10 processes per node, and 4 threads
per process, you would run:</p>
<blockquote>
<p><code>LLsub ./submit.sh [2,10,4]</code></p>
</blockquote>
<p>If you were to run LLstat after running this command, you would see what
looks like a 2 task job array, for example:</p>
<p><code>$ LLstat LLGrid: txe1 (running slurm-wlm 20.11.3) JOBID ARRAY_JOB_ NAME USER START_TIME PARTITION CPUS FEATURES MIN_MEMORY ST NODELIST(REASON) 9651412_1 9651412 submit_LLsub.sh studentx 2021-03-19T10:32:26 normal 40 xeon-g6 8500M R d-13-8-2 9651412_2 9651412 submit_LLsub.sh studentx 2021-03-19T10:32:26 normal 40 xeon-g6 8500M R d-13-8-1</code></p>
<p>However, you are still running 2*10 = 20 total processes. Triples mode
uses slurm to request full nodes, then takes care of launching the
processes on each node. This is why you\'ll always see one task for each
node in the <code>LLstat</code> output, rather than each process. One advantage of
this is it makes for a more compact <code>LLstat</code> output that is easier to
read, instead of having to scroll through tons of tasks.</p>
<p>You can check on your individual processes by looking at the log files.
LLsub with Triples mode will create a directory with the prefix
\"LLSUB\" followed by a unique number to hold all the log files. Within
this directory will be one launch log file, which will capture any
errors that occur during launch ,and one directory per node and put the
log files for each process in its node\'s directory. These
subdirectories are labeled with the process ID range and the node name.</p>
<p>For example, here are the log files from a triples run using [2,4,10]:</p>
<p><code>$ ls LLSUB.23004 README.md helpers.py submit_LLsub.sh submit_sbatch.sh top5each.py $ ls LLSUB.23004/ llsub-triple-mode-launch.log-10006591 p0-p3_d-19-4-1 p4-p7_d-19-3-4 $ ls LLSUB.23004/p0-p3_d-19-4-1/ submit_LLsub.sh.log.4 submit_LLsub.sh.log.5 submit_LLsub.sh.log.6 submit_LLsub.sh.log.7 $ ls LLSUB.23004/p4-p7_d-19-3-4/ submit_LLsub.sh.log.4 submit_LLsub.sh.log.5 submit_LLsub.sh.log.6 submit_LLsub.sh.log.7</code></p>
<p>In this example, <code>LLSUB.23004</code> is the directory containing the log
files, <code>llsub-triple-mode-launch.log-10006591</code> is the log file for the
job launch. <code>p0-p3_d-19-4-1</code> and <code>p4-p7_d-19-3-4</code> are the directories
for each node, and <code>submit_LLsub.sh.log.0</code>, <code>submit_LLsub.sh.log.1</code>,
..., <code>submit_LLsub.sh.log.7</code> are the log files for each process.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../submitting-jobs/" class="btn btn-neutral float-left" title="Submitting Jobs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../best-practices/filesystem/" class="btn btn-neutral float-right" title="Best Practices for using the Filesystem">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../submitting-jobs/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../best-practices/filesystem/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
