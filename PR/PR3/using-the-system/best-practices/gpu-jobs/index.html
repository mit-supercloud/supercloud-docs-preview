<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://supercloud.mit.edu/using-the-system/best-practices/gpu-jobs/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Optimizing your GPU Jobs - SuperCloud Docs</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Optimizing your GPU Jobs";
        var mkdocs_page_input_path = "using-the-system/best-practices/gpu-jobs.md";
        var mkdocs_page_url = "/using-the-system/best-practices/gpu-jobs/";
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> SuperCloud Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../requesting-account/">Requesting an Account</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../getting-started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../systems-and-software/">Systems and Software</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../acknowledging-us/">Acknowledging Us</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Using the System</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="#">Files and Data</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../files-and-data/transferring-files/">Transferring Files</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../files-and-data/shared-groups/">Shared Groups</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../software-packages/">Software and Package Management</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../monitoring-system-and-jobs/">Monintoring System and Job Status</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Submitting Jobs</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../submitting-jobs/submitting-jobs/">Submitting Jobs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../submitting-jobs/job-array-triples/">Job Array Triples</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Best Practices</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../filesystem/">Best Practices for using the Filesystem</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Optimizing your GPU Jobs</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#getting-more-out-of-the-gpus">Getting More out of the GPUs</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#requesting-more-gpus">Requesting More GPUs</a>
    </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../web-portal/">Web Portal</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../databases/">Databases</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../jupyter-notebooks/">Jupyter Notebooks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Additional Resources</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../faqs/">Frequently Asked Questions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../getting-help/">Getting Help</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Glossary</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">SuperCloud Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Using the System &raquo;</li>
          <li>Best Practices &raquo;</li>
      <li>Optimizing your GPU Jobs</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="optimizing-your-gpu-jobs-gpu_jobs">Optimizing your GPU Jobs {#gpu_jobs}<a class="headerlink" href="#optimizing-your-gpu-jobs-gpu_jobs" title="Permanent link"></a></h1>
<p>The GPUs on Supercloud often are in very high demand. Before asking for
more GPUs you\'ll want to do what you can to optimize your code to get
the most out of the resources you do have.</p>
<p>The first thing you need to do is profile your code. Time your code both
with and without the GPU. When you are running with a GPU, monitor the
GPU Utilization and GPU Memory use. You can do this by going to the
compute node where it is running (get the node name from LLstat, then
ssh to the node with \"<code>ssh nodename</code>\") and run the <code>nvidia-smi -l</code>
command (press <code>Ctrl+C</code> to exit <code>nvidia-smi -l</code>when you are done).</p>
<p>If your GPU utilization and GPU memory use is low, that means you
aren\'t getting the full advantage out of the GPU. If this is the case,
try out some of the suggestions below.</p>
<p>If you are only getting a small speedup, say 2x or 4x, especially after
trying the suggestions below, it may not be worthwhile using GPUs at
all. In general, the CPU nodes on Supercloud are more available so we
will likely be willing to increase your allocation of CPU nodes to make
up for the small loss of speedup switching to CPUs.</p>
<h2 id="getting-more-out-of-the-gpus">Getting More out of the GPUs<a class="headerlink" href="#getting-more-out-of-the-gpus" title="Permanent link"></a></h2>
<p>If your GPU utilization and memory use are low, usually this means you
might be able to get some more performance out of the GPUs. There are a
few things you can try if you are training machine learning models:</p>
<ul>
<li>Increase the batch size.</li>
<li>Enable CUDA kernel tuning.<ul>
<li>For Pytorch, add this before the training starts:
    <code>torch.backends.cudnn.benchmark = True</code></li>
<li>For Tensorflow, set this environment variable in your submission
    script: <code>export TF_CUDNN_USE_AUTOTUNE=1</code></li>
</ul>
</li>
<li>If you are using Tensorflow you can also try mixed-precision
    training (we haven't played with this in Pytorch, but it could be
    possible).<ul>
<li>Tensorflow 2.4.1 and newer (anaconda/2021a)<ul>
<li>Add the following to the beginning of your Python code:<ul>
<li><code>from tensorflow.keras import mixed_precision</code></li>
<li><code>policy = mixed_precision.Policy('mixed_float16')</code></li>
<li><code>mixed_precision.set_global_policy(policy)</code></li>
</ul>
</li>
</ul>
</li>
<li>Pre-Tensorflow 2.4.1 (anaconda/2020b and older)<ul>
<li>To do so set the following environment variables in your
    submission script:<ul>
<li><code>export TF_ENABLE_AUTO_MIXED_PRECISION_GRAPH_REWRITE=1</code></li>
<li><code>export TF_ENABLE_AUTO_MIXED_PRECISION=1</code></li>
</ul>
</li>
<li>And add this to your Python code, here <code>opt</code> is the
    optimizer object:<ul>
<li><code>opt = tf.train.experimental.enable_mixed_precision_graph_rewrite(opt)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>If the number of filters in the model layers is a multiple of 64,
    you will see an additional speedup because the V100 tensor cores are
    optimized for matmul/conv ops of these sizes.</li>
<li>If both GPU utilization and memory are below 50% you could try to
    train two models per GPU. This isn't too hard to do with <code>Triples
    Mode &lt;job_array_triples&gt;</code>{.interpreted-text role="ref"}, simply set
    the number of processes per node to 4.</li>
</ul>
<h2 id="requesting-more-gpus">Requesting More GPUs<a class="headerlink" href="#requesting-more-gpus" title="Permanent link"></a></h2>
<p>If you have tried the above suggestions and you still find you need more
GPUs you can put in a request. Send an email to
<a href="mailto:supercolud@mit.edu">supercloud\@mit.edu</a> and tell us what you
need, what you need it for, and how long you need the allocation
increase. Are you trying to run a large distributed training run, or are
you doing hyperparameter searches? Justify your request with numbers:
show us that you have compared CPU and GPU run times, that you have good
GPU utilization, and that you have tried the above suggestions. Explain
how you got to the number of GPUs you are requesting. If the system is
not too busy we may grant your request. Keep in mind that others are
likely to have the same paper deadlines as you and we may not be able to
grant requests during these busy periods, so plan ahead.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../filesystem/" class="btn btn-neutral float-left" title="Best Practices for using the Filesystem"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../web-portal/" class="btn btn-neutral float-right" title="Web Portal">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../filesystem/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../web-portal/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
